<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>3-phase PV router: A 3-phase photovoltaic router/diverter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">3-phase PV router
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">A 3-phase photovoltaic router/diverter </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="description"></a>
Description</h1>
<p><a class="el" href="Mk2__3phase__RFdatalog__temp_8ino.html" title="A photovoltaic energy diverter.">Mk2_3phase_RFdatalog_temp.ino</a> - Arduino program that maximizes the use of home photovoltaic production by monitoring energy consumption and diverting power to one or more resistive charge(s) when needed. In the absence of such a system, surplus energy flows away to the grid and is of no benefit to the PV-owner.</p>
<h1><a class="anchor" id="history"></a>
History</h1>
<p><b>Issue 1 was released in January 2015.</b></p>
<p>This sketch provides continuous monitoring of real power on three phases. Surplus power is diverted to multiple loads in sequential order. A suitable output-stage is required for each load; this can be either triac-based, or a Solid State Relay.</p>
<p>Datalogging of real power and Vrms is provided for each phase. The presence or absence of the RFM12B needs to be set at compile time</p>
<p><b>January 2016, renamed as Mk2_3phase_RFdatalog_2 with these changes:</b></p><ul>
<li>Improved control of multiple loads has been imported from the equivalent 1-phase sketch, Mk2_multiLoad_wired_6.ino</li>
<li>the ISR has been upgraded to fix a possible timing anomaly</li>
<li>variables to store ADC samples are now declared as "volatile"</li>
<li>for RF69 RF module is now supported</li>
<li>a performance check has been added with the result being sent to the Serial port</li>
<li>control signals for loads are now active-high to suit the latest 3-phase PCB</li>
</ul>
<p><b>February 2016, renamed as Mk2_3phase_RFdatalog_3 with these changes:</b></p><ul>
<li>improvements to the start-up logic. The start of normal operation is now synchronized with the start of a new mains cycle.</li>
<li>reduce the amount of feedback in the Low Pass Filter for removing the DC content from the SampleV stream. This resolves an anomaly which has been present since the start of this project. Although the amount of feedback has previously been excessive, this anomaly has had minimal effect on the system's overall behaviour.</li>
<li>The reported power at each of the phases has been inverted. These values are now in line with the Open Energy Monitor convention, whereby import is positive and export is negative.</li>
</ul>
<p><b>February 2020: updated to Mk2_3phase_RFdatalog_3a with these changes:</b></p><ul>
<li><p class="startli">removal of some redundant code in the logic for determining the next load state.</p>
<p class="startli">Robin Emley www.Mk2PVrouter.co.uk</p>
</li>
</ul>
<p><b>October 2019, renamed as Mk2_3phase_RFdatalog_temp with these changes:</b></p><ul>
<li>This sketch has been restructured in order to make better use of the ISR.</li>
<li>All of the time-critical code is now contained within the ISR and its helper functions.</li>
<li>Values for datalogging are transferred to the main code using a flag-based handshake mechanism.</li>
<li>The diversion of surplus power can no longer be affected by slower activities which may be running in the main code such as Serial statements and RF.</li>
<li>Temperature sensing is supported. A pullup resistor (4K7 or similar) is required for the Dallas sensor.</li>
<li>The output mode, i.e. NORMAL or ANTI_FLICKER, is now set at compile time.</li>
<li>Also:<ul>
<li>The ADC is now in free-running mode, at ~104 Âµs per conversion.</li>
<li>a persistence check has been added for zero-crossing detection (polarityConfirmed)</li>
<li>a lowestNoOfSampleSetsPerMainsCycle check has been added, to detect any disturbances</li>
<li>Vrms has been added to the datalog payload (as Vrms x 100)</li>
<li>temperature has been added to the datalog payload (as degrees C x 100)</li>
<li>the phaseCal/f_voltageCal mechanism has been modified to be the same for all phases</li>
<li>RF capability made switchable so that the code will continue to run when an RF module is not fitted. Dataloging can then take place via the Serial port.</li>
<li>temperature capability made switchable so that the code will continue to run w/o sensor.</li>
<li>priority pin changed to handle peak/off-peak tariff</li>
<li>add rotating load priorities: this sketch is intended to control a 3-phase water heater which is composed of 3 independent heating elements wired in WYE with a neutral wire. The router will control each element in a specific order. To ensure that in average (over many days/months), each load runs the same time, each day, the router will rotate the priorities.</li>
<li>most functions have been splitted in one or more sub-functions. This way, each function has a specific task and is much smaller than before.</li>
<li>renaming of most of the variables with a single-letter prefix to identify its type.</li>
<li>direct port manipulation to save code size and speed-up performance</li>
</ul>
</li>
</ul>
<p><b>January 2020, changes:</b></p><ul>
<li>This sketch has been again re-engineered. All 'defines' have been removed except the ones for compile-time optional functionalities.</li>
<li>All constants have been replaced with constexpr initialized at compile-time</li>
<li>all number-types have been replaced with fixed width number types</li>
<li>old fashion enums replaced by scoped enums with fixed types</li>
<li>off-peak tariff made switchable at compile-time</li>
<li>rotation of load priorities made switchable at compile-time</li>
<li>enhanced configuration for override specific loads during off-peak period</li>
</ul>
<p><b>April 2020, changes:</b></p><ul>
<li>Fix a bug in the load level calculation</li>
</ul>
<p><b>May 2020, changes:</b></p><ul>
<li>Fix a bug in the initialization of off-peak offsets</li>
<li>added detailed configuration on start-up with build timestamp</li>
</ul>
<p><b>June 2020, changes:</b></p><ul>
<li>Add force pin for full power through overwrite switch</li>
<li>Add priority rotation for single tariff</li>
</ul>
<p><b>October 2020, changes:</b></p><ul>
<li>Moving some part around (calibration values toward beginning of the sketch)</li>
<li>renaming some preprocessor defines</li>
<li>system/user specific data moved toward beginning of the sketch</li>
</ul>
<p><b>January 2021, changes:</b></p><ul>
<li>Further optimization</li>
<li>now it's possible to specify the override period in minutes and hours</li>
<li>initialization of runtime parameters for override period at compile-time</li>
</ul>
<p><b>February 2021, changes:</b></p><ul>
<li>Added temperature threshold for off-peak period</li>
</ul>
<p><b>April 2021, renamed as Mk2_3phase_RFdatalog_temp with these changes:</b></p><ul>
<li>since this sketch is under source control, no need to write the version in the name</li>
<li>rename function 'checkLoadPrioritySelection' to function's job</li>
<li>made forcePin presence configurable</li>
<li>added WatchDog LED (blink 1s ON/ 1s OFF)</li>
<li>code enhanced to support 6 loads</li>
</ul>
<p><b>November 2021, changes:</b></p><ul>
<li>heavy refactoring/restructuring of the sketch</li>
<li>calibration values moved to the dedicated file '<a class="el" href="calibration_8h.html" title="Calibration values definition.">calibration.h</a>'</li>
<li>user-specific values (pins, ...) are now in '<a class="el" href="config_8h.html" title="Configuration values to be set by the end-user.">config.h</a>' all other files should/must remain unchanged</li>
<li>added support of temperature sensors (virtually no limit of sensors count)</li>
<li>added support for emonESP (see <a href="https://github.com/openenergymonitor/EmonESP">https://github.com/openenergymonitor/EmonESP</a>)</li>
</ul>
<p><b>January 2023: changes:</b></p><ul>
<li>the datalogging accumulator for Vsquared has been rescaled to 1/16 of its previous value to avoid the risk of overflowing during a 20-second datalogging period.</li>
</ul>
<p><b>February 2023: changes:</b></p><ul>
<li>heavy refactoring</li>
<li>compile-time validation for pin assignment and a couple of values</li>
<li>project can now be used with both Arduino IDE and PlatformIO (Visual Studio Code).</li>
<li>a couple of pre-defined PlatformIO configs added</li>
</ul>
<p><b>June 2023: changes:</b></p><ul>
<li>heavy refactoring (again)</li>
<li>stl add-ons</li>
<li>add relay-output feature</li>
</ul>
<p><b>February 2024: changes:</b></p><ul>
<li>refactoring of 'temperature feature'</li>
<li>refactoring of 'relay feature'</li>
<li>new sliding average (EWMA)</li>
<li>more documentation</li>
</ul>
<p><b>March 2024: changes:</b></p><ul>
<li>multi-relay feature</li>
<li>add DEMA and TEMA sliding average</li>
<li>some tiny fixes</li>
<li>even more documentation</li>
</ul>
<dl class="section author"><dt>Author</dt><dd>Fred Metrich </dd></dl>
<dl class="section copyright"><dt>Copyright</dt><dd>Copyright (c) 2024 </dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
